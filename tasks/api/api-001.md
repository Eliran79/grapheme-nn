---
id: api-001
title: 'Review Core Data Structures: Node, Edge, DagNN'
status: done
priority: high
tags:
- api
dependencies:
- setup-001
assignee: developer
created: 2025-12-05T19:55:12.896880545Z
estimate: ~
complexity: 3
area: api
---

# Review Core Data Structures: Node, Edge, DagNN

> **⚠️ SESSION WORKFLOW NOTICE (for AI Agents):**
>
> **This task should be completed in ONE dedicated session.**

## Context
Review and align the core data structures with GRAPHEME_Vision.md specification.
Implement missing structures: DagNN, Clique, TopologicalOrder, GraphMemory.

## Objectives
- [x] Review GRAPHEME_Vision.md data structure specs
- [x] Review current grapheme-core implementation
- [x] Implement DagNN matching vision spec
- [x] Add supporting structures (Clique, TopologicalOrder, GraphMemory)
- [x] Add comprehensive tests
- [x] All tests pass (24 tests)

## Tasks
- [x] Add NodeId type alias
- [x] Add CompressionType enum
- [x] Add Clique struct with label support
- [x] Add TopologicalOrder with position lookup
- [x] Add GraphMemory for transformation patterns
- [x] Add TransformationPattern struct
- [x] Implement DagNN struct
- [x] Add Node constructors (input, hidden, output, clique, pattern, compressed)
- [x] Add Edge constructors (sequential, semantic, skip, clique)
- [x] Enable petgraph serde-1 feature for serialization
- [x] Add 7 new tests for DagNN and related structures

## Acceptance Criteria
✅ **Data Structures:**
- DagNN struct matches GRAPHEME_Vision.md spec
- All node types implemented (Input, Hidden, Output, Clique, Pattern, Compressed)
- All edge types implemented (Sequential, Semantic, Structural, Clique, Skip)

✅ **Build & Test:**
- `cargo build` succeeds
- `cargo test` passes (24 tests)

## Technical Notes
- petgraph's serde-1 feature enabled for NodeIndex serialization
- GraphemeGraph kept for backwards compatibility
- DagNN is the new preferred structure for new code
- TopologicalOrder uses petgraph::algo::toposort

## Updates
- 2025-12-05: Task created
- 2025-12-05: Implemented DagNN, Clique, TopologicalOrder, GraphMemory - 24 tests pass

## Session Handoff (AI: Complete this when marking task done)
**For the next session/agent working on dependent tasks:**

### What Changed
- **grapheme-core/src/lib.rs** - Major expansion with new structures:
  - `NodeId` type alias for `NodeIndex`
  - `CompressionType` enum (RunLength, PatternBased, Hierarchical, Semantic)
  - `Clique` struct with id, members, strength, label
  - `TopologicalOrder` struct with order vector and position HashMap
  - `TransformationPattern` struct for storing learned patterns
  - `GraphMemory` struct for pattern storage with capacity limits
  - `DagNN` struct - the main graph structure matching vision spec
  - New Node constructors: `output()`, `clique()`, `pattern()`, `compressed()`
  - New Edge constructors: `semantic()`, `skip()`, `clique()`

- **Cargo.toml** - Enabled `serde-1` feature on petgraph

### Causality Impact
- `DagNN::from_text()` now computes TopologicalOrder automatically
- `DagNN::update_topology()` must be called after graph modifications
- `GraphMemory::store()` implements LRU-like eviction based on frequency
- Cliques can be formed with `DagNN::form_clique()`

### Dependencies & Integration
- petgraph now has `serde-1` feature enabled
- `DagNN` can be serialized (via petgraph's serde support)
- `Clique`, `TopologicalOrder`, `GraphMemory` are new public types
- `GraphemeGraph` kept for backwards compatibility

### Verification & Testing
```bash
cargo build        # Should succeed
cargo test         # 24 tests should pass
```

New tests:
- `test_dagnn_from_text` - DagNN creation from text
- `test_dagnn_roundtrip` - Text roundtrip through DagNN
- `test_topological_order` - TopologicalOrder verification
- `test_clique_creation` - Clique formation
- `test_node_types` - All Node type constructors
- `test_edge_types` - All Edge type constructors
- `test_graph_memory` - GraphMemory storage and eviction

### Context for Next Task
- **api-002** (Trait API Design) can now proceed
- Key new types: `DagNN`, `Clique`, `TopologicalOrder`, `GraphMemory`
- `DagNN` is the recommended structure for new code
- `TopologicalOrder` enables efficient forward propagation
- `GraphMemory` provides pattern storage for learning
- Consider implementing `ForwardPass` trait using `TopologicalOrder`
