---
id: api-002
title: 'Review Trait API Design: TextProcessor, GraphBuilder, ForwardPass'
status: done
priority: high
tags:
- api
dependencies:
- setup-001
- api-001
assignee: developer
created: 2025-12-05T19:55:16.453032927Z
estimate: ~
complexity: 3
area: api
---

# Review Trait API Design: TextProcessor, GraphBuilder, ForwardPass

> **⚠️ SESSION WORKFLOW NOTICE (for AI Agents):**
>
> **This task should be completed in ONE dedicated session.**

## Context
Design and implement trait APIs for the GRAPHEME neural network architecture,
enabling graph-based text processing, forward propagation, transformation, and clique processing.

## Objectives
- [x] Review GRAPHEME_Vision.md trait specifications
- [x] Review current TextProcessor trait
- [x] Implement GraphBuilder trait
- [x] Implement ForwardPass trait
- [x] Implement GraphTransformer trait
- [x] Implement CliqueProcessor trait
- [x] Add comprehensive tests
- [x] All tests pass (30 tests)

## Tasks
- [x] Add CompressedRegion struct
- [x] Add HierarchicalGraph struct
- [x] Implement GraphBuilder trait for DagNN
- [x] Implement ForwardPass trait for DagNN
- [x] Add TransformRule struct
- [x] Implement GraphTransformer trait + BasicGraphTransformer
- [x] Implement CliqueProcessor trait for DagNN
- [x] Add 6 new tests for trait APIs
- [x] Fix EdgeRef import for forward pass
- [x] Fix borrow checker issue in form_cliques

## Acceptance Criteria
✅ **Trait Implementation:**
- GraphBuilder: add_character, connect_relevant, form_cliques, compress_region, build_hierarchy
- ForwardPass: activate_node, forward, forward_parallel, get_activations
- GraphTransformer: transform, learn_transformation, apply_rule, compose
- CliqueProcessor: find_cliques_parallel, strengthen_clique, compress_to_clique, expand_clique

✅ **Build & Test:**
- `cargo build` succeeds
- `cargo test` passes (30 tests)

## Technical Notes
- GraphBuilder enables incremental graph construction with character-level processing
- ForwardPass uses TopologicalOrder for efficient forward propagation
- GraphTransformer provides graph-to-graph transformation with learnable rules
- CliqueProcessor handles clique detection and compression
- BasicGraphTransformer is provided as a simple implementation

## Testing
- [x] Write unit tests for new functionality (6 new tests)
- [x] Ensure all tests pass before marking task complete

## Updates
- 2025-12-05: Task created
- 2025-12-05: Implemented 4 traits with tests - 30 tests pass

## Session Handoff (AI: Complete this when marking task done)
**For the next session/agent working on dependent tasks:**

### What Changed
- **grapheme-core/src/lib.rs** - Added trait APIs and implementations:
  - `CompressedRegion` struct for region compression results
  - `HierarchicalGraph` struct with levels of node hierarchies
  - `GraphBuilder` trait: incremental graph construction
    - `add_character(ch, position)` - add character node
    - `connect_relevant(node, context_window)` - connect to nearby nodes
    - `form_cliques()` - detect and form cliques from node windows
    - `compress_region(start, end)` - compress node range
    - `build_hierarchy()` - create hierarchical graph representation
  - `ForwardPass` trait: neural forward propagation
    - `activate_node(node)` - get node activation
    - `forward()` - sequential forward pass using TopologicalOrder
    - `forward_parallel()` - parallel forward pass (uses rayon)
    - `get_activations()` - retrieve all node activations
  - `TransformRule` struct: transformation pattern with id, description, patterns
  - `GraphTransformer` trait: graph-to-graph transformations
    - `transform(input)` - apply transformation
    - `learn_transformation(input, target)` - learn rule from examples
    - `apply_rule(graph, rule)` - apply specific rule
    - `compose(rules)` - compose multiple rules
  - `BasicGraphTransformer` struct: simple identity transformer
  - `CliqueProcessor` trait: clique operations
    - `find_cliques_parallel()` - parallel clique detection
    - `strengthen_clique(clique, factor)` - adjust clique strength
    - `compress_to_clique(nodes)` - compress nodes into clique
    - `expand_clique(clique_id)` - expand clique to member nodes

- Added `use petgraph::visit::EdgeRef;` for edge traversal in forward pass

### Causality Impact
- `ForwardPass::forward()` processes nodes in TopologicalOrder
- Activations propagate from predecessors to successors
- Input nodes maintain activation of 1.0
- Hidden/output nodes compute weighted average of inputs
- `form_cliques()` creates overlapping cliques from consecutive 3-node windows

### Dependencies & Integration
- Traits are implemented on `DagNN` struct from api-001
- Uses `TopologicalOrder` for forward propagation order
- Uses `Clique` struct for clique operations
- `BasicGraphTransformer` can be used as a starting point for custom transformers

### Verification & Testing
```bash
cargo build        # Should succeed
cargo test         # 30 tests should pass
```

New tests (6 added):
- `test_graph_builder_trait` - GraphBuilder methods
- `test_forward_pass_trait` - ForwardPass propagation
- `test_graph_transformer_trait` - GraphTransformer learning
- `test_clique_processor_trait` - CliqueProcessor operations
- `test_form_cliques_via_trait` - Clique formation from windows
- `test_compress_region` - Region compression

### Context for Next Task
- **backend-001** through **backend-005** can now proceed with layer implementations
- Key traits: `GraphBuilder`, `ForwardPass`, `GraphTransformer`, `CliqueProcessor`
- `DagNN` implements all traits and is the main entry point
- `BasicGraphTransformer` is a simple identity transformer - extend for real transformations
- Forward pass uses simple ReLU-like activation: `max(0, min(1, weighted_avg))`
- Cliques are formed from overlapping 3-node windows for now
